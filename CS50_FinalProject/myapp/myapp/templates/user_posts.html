{% extends "layout.html" %}

{% block main %}

    <h3 class="mb-1">{{ user.username }}'s Posts</h3>
    <p class="mb-0">{{ user.about }}</p>

    <div class="row justify-content-center">
        {% for post in posts.items %}
        <div class="col-md-4 card card-home px-0">
            <img class="rounded-top" src="{{ url_for('static', filename='post_pics/' + post.image_file) }}" alt="Image not found">
            <div class="card-body">
                <h5 class="card-title"><a class="article-title" href="{{ url_for('posts.post', post_id=post.id) }}">{{ post.title }}</a></h5>
                <div class="card-text">{{ post.content }}</div>
                <div class="d-flex flex-column align-items-end">
                    <div class="mt-2">
                        <form class="btn btn-no-border mx-2" method="POST" action="{{ url_for('users.user_posts', username=post.author.username) }}" novalidate>
                            {{ form.csrf_token}}
                            {{ form.liked_post_id(value=post.id) }}
                            {{ form.page(value=posts.page) }}
                            {% if post.id in like_list %}
                                {{ form.action(value='unlike') }}
                                <button type="submit" class="symbol-heights btn-no-border">
                                    <img src="{{ url_for('static', filename='icons/liked.png') }}" alt="liked" class="symbol-heights">
                                </button>
                            {% else %}
                                {{ form.action(value='like') }}
                                <button type="submit" class="symbol-heights btn-no-border">
                                    <img src="{{ url_for('static', filename='icons/like.png') }}" alt="liked" class="symbol-heights">
                                </button>
                            {% endif %}
                        </form>
                        <button class="btn btn-dark" type="button" 
                                data-bs-toggle="offcanvas" data-bs-target="#offcanvas{{ post.id }}" 
                                aria-controls="offcanvas{{ post.id }}">Info
                        </button>
                        </div>
                    </div>
                </div>
            </div>
                
            <div class="offcanvas offcanvas-end" tabindex="-1" 
                id="offcanvas{{ post.id }}" aria-labelledby="offcanvas{{ post.id }}Label">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvas{{ post.id }}Label"><b>{{ post.title }}</b></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-img text-center">
                    <a href="{{ url_for('users.user_posts', username=post.author.username) }}">
                        <img class="rounded-circle article-img" 
                        src="{{ url_for('static', filename='profile_pics/' + post.author.image_file) }}">
                    </a>
                </div>
                <div class="offcanvas-text">
                    <b> <a class="article-title no-underline" href="{{ url_for('users.user_posts', username=post.author.username) }}">{{ post.author.username }}</a></b><br>
                    {{ post.author.about }}<br>
                    <hr>
                    <b>Date:</b> {{ post.date_posted.strftime('%Y-%m-%d') }}<br>
                    <b>Update:</b> {{ post.date_updated.strftime('%Y-%m-%d') }}<br>
                    <b>Content:</b> {{ post.content }}<br>
                    <hr>
                    {% if Like.query.filter_by(post_id=post.id).count() == 0 %}
                        <b>Liked by:</b>
                    {% else %}
                        <b>Liked by {{ Like.query.filter_by(post_id=post.id).count() }} users:</b>
                    {% endif %}                    
                    <div class="container">
                        {% for person in Like.query.filter_by(post_id=post.id).order_by(Like.id.desc()).all() %}
                            <a href="{{ url_for('users.user_posts', username=person.user.username) }}">
                                <img class="rounded-circle article-img" 
                                src="{{ url_for('static', filename='profile_pics/' + person.user.image_file) }}">
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %} 
    </div>

    <div class="container pagination mt-3">
        {% for page_num in posts.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
            {% if page_num %}
                {% if posts.page == page_num %}
                    <a class="btn btn-dark mb-4" href="{{ url_for('users.user_posts', username=user.username, page=page_num) }}">{{ page_num }}</a>
                {% else %}
                    <a class="btn btn-outline-dark mb-4" href="{{ url_for('users.user_posts', username=user.username, page=page_num) }}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                &nbsp;&nbsp;&nbsp;&nbsp;
            {% endif %}
        {% endfor %}
    </div>

{% endblock %}
